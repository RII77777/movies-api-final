<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Movies API</title>
</head>
<body>

  <h1>Movies Database</h1>

  <div style="background:#f0f0f0; padding:20px; margin-bottom:20px;">
    <h2>Authentication</h2>
    <h3>Register</h3>
    <input id="regEmail" placeholder="Email"><br><br>
    <input id="regPassword" type="password" placeholder="Password"><br><br>
    <button onclick="register()">Register</button>

    <h3>Login</h3>
    <input id="loginEmail" placeholder="Email"><br><br>
    <input id="loginPassword" type="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <div id="tokenDisplay" style="margin-top:10px; word-break:break-all;"></div>
  </div>

  <h2>Add Movie (admin only)</h2>
  <input id="title" placeholder="Title"><br><br>
  <input id="director" placeholder="Director"><br><br>
  <input id="year" type="number" placeholder="Year"><br><br>
  <input id="genre" placeholder="Genre"><br><br>
  <input id="description" placeholder="Description"><br><br>
  <input id="image" placeholder="Image URL"><br><br>
  <button onclick="addMovie()">Add Movie</button>

  <h2>All Movies</h2>
  <div id="movies"></div>

  <h2>Add Review</h2>
  <input id="movieId" placeholder="Movie ID"><br><br>
  <input id="author" placeholder="Your Name"><br><br>
  <textarea id="text" placeholder="Review text" rows="4" cols="50"></textarea><br><br>
  <input id="rating" type="number" min="1" max="5" placeholder="Rating (1-5)"><br><br>
  <button onclick="addReview()">Add Review</button>

  <h2>All Reviews</h2>
  <div id="reviews"></div>

  <script>
    let token = "";

    async function register() {
      const email = document.getElementById("regEmail").value;
      const password = document.getElementById("regPassword").value;

      const res = await fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();
      alert(data.message);
    }

    async function login() {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      const res = await fetch("/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();
      if (res.ok) {
        token = data.token;
        document.getElementById("tokenDisplay").innerHTML = 
          `<strong>Logged in as:</strong> ${data.user.email} (${data.user.role})<br>
           <strong>Token:</strong> ${token.substring(0, 50)}...`;
        loadMovies();
        loadReviews();
      } else {
        alert("Error: " + data.message);
      }
    }

    async function addMovie() {
      const movie = {
        title: document.getElementById("title").value,
        director: document.getElementById("director").value,
        year: Number(document.getElementById("year").value),
        genre: document.getElementById("genre").value,
        description: document.getElementById("description").value,
        image: document.getElementById("image").value
      };

      const res = await fetch("/api/movies", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(movie)
      });

      const data = await res.json();
      if (res.ok) {
        alert("Movie added successfully");
        loadMovies();
      } else {
        alert("Error: " + data.message);
      }
    }

    async function addReview() {
      const review = {
        movieId: document.getElementById("movieId").value,
        author: document.getElementById("author").value,
        text: document.getElementById("text").value,
        rating: Number(document.getElementById("rating").value)
      };

      const res = await fetch("/api/reviews", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(review)
      });

      const data = await res.json();
      if (res.ok) {
        alert("Review added successfully");
        loadReviews();
      } else {
        alert("Error: " + data.message);
      }
    }

    async function loadMovies() {
      const res = await fetch("/api/movies");
      const movies = await res.json();

      const container = document.getElementById("movies");
      container.innerHTML = "";

      movies.forEach(m => {
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.margin = "10px";
        div.style.padding = "10px";

        div.innerHTML = `
          <img src="${m.image}" width="120"><br><br>
          <strong>${m.title}</strong> (${m.year})<br>
          Director: ${m.director}<br>
          Genre: ${m.genre}<br>
          ${m.description}<br>
          <small>ID: ${m._id}</small>
        `;

        container.appendChild(div);
      });
    }

    async function loadReviews() {
      const res = await fetch("/api/reviews");
      const reviews = await res.json();

      const container = document.getElementById("reviews");
      container.innerHTML = "";

      reviews.forEach(r => {
        const div = document.createElement("div");
        div.style.border = "1px solid #ccc";
        div.style.margin = "10px";
        div.style.padding = "10px";

        div.innerHTML = `
          <strong>${r.author}</strong> (Rating: ${r.rating}/5)<br>
          ${r.text}<br>
          <small>Movie: ${r.movieId ? r.movieId.title : 'Unknown'}</small>
        `;

        container.appendChild(div);
      });
    }

    loadMovies();
    loadReviews();
  </script>

</body>
</html>